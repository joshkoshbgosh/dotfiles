#!/usr/bin/env bash
set -uo pipefail

LOGFILE="/tmp/hypr-session.log"
: > "$LOGFILE"

log() { echo "[$(date +%H:%M:%S)] $*" >> "$LOGFILE"; }
log "=== Starting hypr-session ==="

h() { hyprctl dispatch "$@" >> "$LOGFILE" 2>&1; }

launch() {
    local cmd="$1"
    log "Launching: $cmd"
    h exec "$cmd"
    sleep 0.2
    hyprctl clients -j | jq -r '.[] | .address' | tail -1
}

log "Launching all apps..."
CHROMIUM_ADDR=$(launch "chromium --new-window")
log "Chromium: $CHROMIUM_ADDR"

GHOSTTY_NVIM_ADDR=$(launch "ghostty +new-window -e bash -lc 'cd /home/joshkosh && nvim'")
log "Ghostty nvim: $GHOSTTY_NVIM_ADDR"

GHOSTTY_SHELL_ADDR=$(launch "ghostty +new-window -e bash -lc 'cd /home/joshkosh && exec bash'")
log "Ghostty shell: $GHOSTTY_SHELL_ADDR"

THUNDERBIRD_ADDR=$(launch "thunderbird")
log "Thunderbird: $THUNDERBIRD_ADDR"

DISCORD_ADDR=$(launch "gtk-launch Discord")
log "Discord: $DISCORD_ADDR"

NOTION_ADDR=$(launch "gtk-launch Notion")
log "Notion: $NOTION_ADDR"

NOTION_CAL_ADDR=$(launch "gtk-launch Notion-Calendar")
log "Notion Calendar: $NOTION_CAL_ADDR"

STEAM_ADDR=$(launch "steam -gamepadui")
log "Steam: $STEAM_ADDR"

SPOTIFY_ADDR=$(launch "spotify")
log "Spotify: $SPOTIFY_ADDR"

log "Moving all windows to target workspaces..."
hyprctl --batch "
    dispatch movetoworkspacesilent 1,address:$CHROMIUM_ADDR
    dispatch movetoworkspacesilent 1,address:$GHOSTTY_NVIM_ADDR
    dispatch movetoworkspacesilent 1,address:$GHOSTTY_SHELL_ADDR
    dispatch movetoworkspacesilent 2,address:$THUNDERBIRD_ADDR
    dispatch movetoworkspacesilent 3,address:$DISCORD_ADDR
    dispatch movetoworkspacesilent 3,address:$NOTION_ADDR
    dispatch movetoworkspacesilent 3,address:$NOTION_CAL_ADDR
    dispatch movetoworkspacesilent 4,address:$STEAM_ADDR
    dispatch movetoworkspacesilent 5,address:$SPOTIFY_ADDR
" >> "$LOGFILE" 2>&1

log "Final window state:"
hyprctl clients -j 2>> "$LOGFILE" | jq -r '.[] | "  \(.workspace.id): \(.class) - \(.title)"' >> "$LOGFILE"

log "Switching to workspace 3 (Notion)"
h workspace 3

log "=== hypr-session complete ==="
