#!/usr/bin/env bash
set -uo pipefail

LOGFILE="/tmp/hypr-session.log"
: > "$LOGFILE"

log() { echo "[$(date +%H:%M:%S)] $*" >> "$LOGFILE"; }
log "=== Starting hypr-session ==="

h() { hyprctl dispatch "$@" >> "$LOGFILE" 2>&1; }

launch() {
    local cmd="$1"
    log "Launching: $cmd"
    h exec "$cmd"
}

log "Launching all apps..."
launch "chromium --new-window"
launch "ghostty +new-window -e bash -lc 'cd /home/joshkosh && nvim'"
launch "ghostty +new-window -e bash -lc 'cd /home/joshkosh && exec bash'"
launch "thunderbird"
launch "gtk-launch Discord"
launch "gtk-launch Notion"
launch "gtk-launch Notion-Calendar"
launch "steam -gamepadui"
launch "spotify"

log "Waiting for all windows to appear..."
sleep 3

log "Getting all window addresses..."
hyprctl clients -j > /tmp/hypr-windows.json

log "Extracting addresses by class..."
CHROMIUM_ADDR=$(jq -r '.[] | select(.class == "chromium") | .address' /tmp/hypr-windows.json | head -1)
GHOSTTY_NVIM_ADDR=$(jq -r '.[] | select(.class == "com.mitchellh.ghostty") | .address' /tmp/hypr-windows.json | head -1)
GHOSTTY_SHELL_ADDR=$(jq -r '.[] | select(.class == "com.mitchellh.ghostty") | .address' /tmp/hypr-windows.json | head -2 | tail -1)
THUNDERBIRD_ADDR=$(jq -r '.[] | select(.class == "org.mozilla.Thunderbird") | .address' /tmp/hypr-windows.json | head -1)
DISCORD_ADDR=$(jq -r '.[] | select(.class == "chrome-discord.com__channels_@me-Default") | .address' /tmp/hypr-windows.json | head -1)
NOTION_ADDR=$(jq -r '.[] | select(.class == "chrome-notion.so__-Default") | .address' /tmp/hypr-windows.json | head -1)
NOTION_CAL_ADDR=$(jq -r '.[] | select(.class == "chrome-calendar.notion.so__-Default") | .address' /tmp/hypr-windows.json | head -1)
STEAM_ADDR=$(jq -r '.[] | select(.class == "steam") | .address' /tmp/hypr-windows.json | head -1)
SPOTIFY_ADDR=$(jq -r '.[] | select(.class == "spotify") | .address' /tmp/hypr-windows.json | head -1)

log "Chromium: $CHROMIUM_ADDR"
log "Ghostty nvim: $GHOSTTY_NVIM_ADDR"
log "Ghostty shell: $GHOSTTY_SHELL_ADDR"
log "Thunderbird: $THUNDERBIRD_ADDR"
log "Discord: $DISCORD_ADDR"
log "Notion: $NOTION_ADDR"
log "Notion Calendar: $NOTION_CAL_ADDR"
log "Steam: $STEAM_ADDR"
log "Spotify: $SPOTIFY_ADDR"

log "Moving all windows to target workspaces..."
hyprctl --batch "
    dispatch movetoworkspacesilent 1,address:$CHROMIUM_ADDR
    dispatch movetoworkspacesilent 1,address:$GHOSTTY_NVIM_ADDR
    dispatch movetoworkspacesilent 1,address:$GHOSTTY_SHELL_ADDR
    dispatch movetoworkspacesilent 2,address:$THUNDERBIRD_ADDR
    dispatch movetoworkspacesilent 3,address:$DISCORD_ADDR
    dispatch movetoworkspacesilent 3,address:$NOTION_ADDR
    dispatch movetoworkspacesilent 3,address:$NOTION_CAL_ADDR
    dispatch movetoworkspacesilent 4,address:$STEAM_ADDR
    dispatch movetoworkspacesilent 5,address:$SPOTIFY_ADDR
" >> "$LOGFILE" 2>&1

log "Final window state:"
hyprctl clients -j 2>> "$LOGFILE" | jq -r '.[] | "  \(.workspace.id): \(.class) - \(.title)"' >> "$LOGFILE"

log "Switching to workspace 3 (Notion)"
h workspace 3

log "=== hypr-session complete ==="
