#!/usr/bin/env bash
set -uo pipefail

LOGFILE="/tmp/hypr-session.log"
: > "$LOGFILE"

log() { echo "[$(date +%H:%M:%S)] $*" >> "$LOGFILE"; }
error() { log "ERROR: $*"; hyprctl notify -1 3000 "ERROR: $*" red; }
h() { hyprctl dispatch "$@" >> "$LOGFILE" 2>&1; }

wait_for_class() {
    local class="$1" timeout="${2:-30}"
    local start=$(date +%s)
    while ! hyprctl clients -j | jq -e ".[] | select(.class == \"$class\")" >/dev/null 2>&1; do
        [ $(($(date +%s) - start)) -gt "$timeout" ] && return 1
        sleep 2
    done
}

switch_workspace() {
    local workspace="$1"
    if [[ "$workspace" == special:* ]]; then
        local name="${workspace#special:}"
        h "togglespecialworkspace $name"
    else
        h "workspace $workspace"
        sleep 2
    fi
}

process_workspace() {
    local workspace="$1"; shift
    local apps=("$@")

    switch_workspace "$workspace"

    for app in "${apps[@]}"; do
        IFS='|' read -r name class cmd timeout <<< "$app"
        timeout="${timeout:-$SESSION_DEFAULT_TIMEOUT}"

        log "Launching $name in workspace $workspace"
        h exec "$cmd"

        if ! wait_for_class "$class" "$timeout"; then
            error "$name ($class) timeout"
            continue
        fi
    done
}

SESSION_DEFAULT_TIMEOUT=120

WORKSPACE_1_APPS=(
  "chromium|chromium|chromium --new-window|"
  "ghostty-shell|com.mitchellh.ghostty|ghostty --title=shell -e bash|"
  "ghostty-nvim|com.mitchellh.ghostty|ghostty --title=nvim -e nvim -c 'cd /home/joshkosh'|"
)

WORKSPACE_2_APPS=(
  "thunderbird|org.mozilla.Thunderbird|thunderbird|"
)

WORKSPACE_3_APPS=(
  "notion|chrome-notion.so__-Default|gtk-launch Notion|"
  "notion-calendar|chrome-calendar.notion.so__-Default|gtk-launch Notion-Calendar|"
)

WORKSPACE_4_APPS=(
  "steam|steam|steam|480"
)

WORKSPACE_5_APPS=(
  "nvim-dotfiles|com.mitchellh.ghostty|ghostty --title=nvim-dotfiles -e nvim -c 'cd ~/Work/dotfiles'|"
  "opencode|com.mitchellh.ghostty|ghostty --title=opencode -e bash -c 'cd ~/Work/dotfiles && opencode'|"
)

WORKSPACE_SCRATCHPAD_APPS=(
  "discord|chrome-discord.com__channels_@me-Default|gtk-launch Discord|"
  "scratchpad-chromium|chromium|chromium --new-window --start-maximized|"
  "spotify|spotify|spotify|"
)

log "=== Starting hypr-session ==="
process_workspace 1 "${WORKSPACE_1_APPS[@]}"
process_workspace 2 "${WORKSPACE_2_APPS[@]}"
process_workspace 3 "${WORKSPACE_3_APPS[@]}"
process_workspace 4 "${WORKSPACE_4_APPS[@]}"
process_workspace 5 "${WORKSPACE_5_APPS[@]}"
process_workspace "special:scratchpad" "${WORKSPACE_SCRATCHPAD_APPS[@]}"
h "workspace 3"
hyprctl dispatch togglespecialworkspace scratchpad
log "=== hypr-session complete ==="
