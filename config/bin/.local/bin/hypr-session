#!/usr/bin/env bash
set -uo pipefail

LOGFILE="/tmp/hypr-session.log"
: > "$LOGFILE"

log() { echo "[$(date +%H:%M:%S)] $*" >> "$LOGFILE"; }
error() { log "ERROR: $*"; hyprctl notify -1 3000 "ERROR: $*" red; }

h() { hyprctl dispatch "$@" >> "$LOGFILE" 2>&1; }

SESSION_DEFAULT_TIMEOUT=30

WORKSPACE_1_APPS=(
  "chromium|chromium --new-window|H|10"
  "ghostty-nvim|ghostty --title=nvim -e nvim -c 'cd /home/joshkosh'|V|"
  "ghostty-shell|ghostty --title=shell -e bash||"
)

WORKSPACE_2_APPS=(
  "thunderbird|thunderbird||30"
)

WORKSPACE_3_APPS=(
  "discord|gtk-launch Discord||60"
  "notion|gtk-launch Notion||60"
  "notion-calendar|gtk-launch Notion-Calendar||60"
)

WORKSPACE_4_APPS=(
  "steam|steam -gamepadui||120"
)

WORKSPACE_5_APPS=(
  "spotify|spotify||30"
)

WORKSPACE_SCRATCHPAD_APPS=(
  "spotify|spotify||30"
)

wait_for_class() {
    local class="$1" timeout="${2:-30}"
    local start=$(date +%s)
    while ! hyprctl clients -j | jq -e ".[] | select(.class == \"$class\")" >/dev/null 2>&1; do
        [ $(($(date +%s) - start)) -gt "$timeout" ] && return 1
        sleep 0.5
    done
}

get_address() {
    hyprctl clients -j | jq -r ".[] | select(.class == \"$1\") | .address" | head -1
}

get_workspace() {
    hyprctl clients -j | jq -r ".[] | select(.class == \"$1\") | .workspace.name" | head -1
}

set_split() {
    h layoutmsg dwindle:preset "$1"
}

log "=== Starting hypr-session ==="

for workspace in 1 2 3 4 5 scratchpad; do
    apps_var="WORKSPACE_${workspace^^}_APPS"
    for app in "${!apps_var}"; do
        IFS='|' read -r name cmd split timeout <<< "$app"
        timeout="${timeout:-$SESSION_DEFAULT_TIMEOUT}"

        log "Launching $name in workspace $workspace"
        h exec "[workspace $workspace silent] $cmd"

        if ! wait_for_class "$name" "$timeout"; then
            error "$name timeout"
            continue
        fi

        actual_ws=$(get_workspace "$name")
        if [ "$actual_ws" != "$workspace" ] && [ "$actual_ws" != "special:scratchpad" ]; then
            log "Moving $name from $actual_ws to $workspace"
            h movetoworkspacesilent "$workspace,address:$(get_address "$name")"
        fi

        [ -n "$split" ] && set_split "$split"
    done
done

h workspace 3
log "=== hypr-session complete ==="
